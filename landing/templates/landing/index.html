<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test ATH M√≥vil - CORREGIDO</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 50px auto;
            padding: 20px;
            background: #f0f0f0;
        }
        .card {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 { color: #4DB6AC; }
        .status {
            padding: 15px;
            margin: 20px 0;
            border-radius: 8px;
            display: none;
        }
        .status.show { display: block; }
        .status.success {
            background: #d4edda;
            border: 2px solid #28a745;
            color: #155724;
        }
        .status.error {
            background: #f8d7da;
            border: 2px solid #dc3545;
            color: #721c24;
        }
        #ATHMovil_Checkout_Button_payment {
            margin: 30px 0;
            min-height: 60px;
            border: 2px dashed #ccc;
            padding: 20px;
            text-align: center;
        }
        
        /* Panel de Debug */
        #athDebugPanel {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            border: 3px solid #4DB6AC;
            border-radius: 12px;
            padding: 20px;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            z-index: 999999;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        
        @media (max-width: 768px) {
            #athDebugPanel {
                bottom: 10px;
                right: 10px;
                left: 10px;
                max-width: none;
            }
        }
    </style>
</head>
<body>
    
    <!-- Panel de Debug Visual -->
    <div id="athDebugPanel">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <strong style="color: #4DB6AC; font-size: 16px;">üîç Debug ATH M√≥vil</strong>
            <button onclick="document.getElementById('athDebugPanel').style.display='none'" 
                    style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer;">
                ‚úï
            </button>
        </div>
        <div id="athDebugContent" style="color: #333; line-height: 1.8;">
            <p>‚è≥ Iniciando diagn√≥stico...</p>
        </div>
    </div>

    <!-- Contenido Principal -->
    <div class="card">
        <h1>üß™ Test ATH M√≥vil</h1>
        <p>Prueba m√≠nima del bot√≥n de pago</p>

        <div id="statusMessage" class="status"></div>

        <h3>Monto: $100.00</h3>
        
        <!-- Contenedor del bot√≥n -->
        <div id="ATHMovil_Checkout_Button_payment">
            <p style="color: #999;">El bot√≥n aparecer√° aqu√≠...</p>
        </div>

        <div style="background: #fff3cd; border: 1px solid #ffc107; padding: 15px; border-radius: 5px; margin-top: 20px;">
            <strong>‚ö†Ô∏è Instrucciones:</strong>
            <ol style="margin: 10px 0 0 20px; padding: 0;">
                <li>Revisa el panel de debug (abajo derecha)</li>
                <li>Verifica que aparezca el bot√≥n naranja</li>
                <li>Haz click y prueba el pago</li>
                <li>El panel mostrar√° los errores si los hay</li>
            </ol>
        </div>
    </div>

    <!-- ========================================== -->
    <!-- SCRIPTS ATH M√ìVIL - ORDEN CORRECTO -->
    <!-- ========================================== -->
    
    <!-- 1. CONFIGURACI√ìN (PRIMERO) -->
    <script type="text/javascript">
        console.log('üîß [1/3] Configurando ATHM_Checkout...');
        
        window.ATHM_Checkout = {
            env: 'production',
            publicToken: 'a937f2e32a4e35ebd2c2850d204fd4dc4b515763',
            timeout: 600,
            theme: 'btn',
            lang: 'es',
            total: 100,
            subtotal: 100,
            tax: 0,
            metadata1: 'Donacion Campa√±a',
            metadata2: 'Dr Mendez Sexto',
            items: [{
                name: "Donaci√≥n Campa√±a",
                description: "Apoyo campa√±a Dr. M√©ndez Sexto",
                quantity: "1",
                price: "100",
                tax: "0",
                metadata: "Renovar para Avanzar"
            }],
            phoneNumber: ""
        };
        
        console.log('‚úÖ ATHM_Checkout configurado');
        
        // Callbacks
        window.authorizationATHM = async function() {
            console.log('‚úÖ PAGO AUTORIZADO');
            const statusDiv = document.getElementById('statusMessage');
            if (statusDiv) {
                statusDiv.className = 'status success show';
                statusDiv.innerHTML = '<h3>‚úÖ ¬°Pago exitoso!</h3><p>El sistema funciona correctamente.</p>';
            }
        };
        
        window.cancelATHM = async function() {
            console.log('‚ùå PAGO CANCELADO');
            const statusDiv = document.getElementById('statusMessage');
            if (statusDiv) {
                statusDiv.className = 'status error show';
                statusDiv.innerHTML = '<h3>‚ùå Pago cancelado</h3><p>Revisa el panel de debug.</p>';
            }
        };
        
        window.expiredATHM = async function() {
            console.log('‚è±Ô∏è PAGO EXPIRADO');
            const statusDiv = document.getElementById('statusMessage');
            if (statusDiv) {
                statusDiv.className = 'status error show';
                statusDiv.innerHTML = '<h3>‚è±Ô∏è Tiempo expirado</h3>';
            }
        };
        
        console.log('‚úÖ [1/3] Callbacks definidos');
    </script>
    
    <!-- 2. SCRIPT ATH M√ìVIL (SEGUNDO) -->
    <script src="https://payments.athmovil.com/api/js/athmovil_base.js" 
            onload="console.log('‚úÖ [2/3] Script ATH cargado')"
            onerror="console.error('‚ùå [2/3] Error cargando script ATH')">
    </script>
    
    <!-- 3. DEBUG VISUAL (TERCERO) -->
    <script type="text/javascript">
        console.log('üîß [3/3] Inicializando debug...');
        
        function logVisual(message, type = 'info') {
            const content = document.getElementById('athDebugContent');
            if (!content) return;
            
            const colors = { 'info': '#2196F3', 'success': '#4CAF50', 'error': '#F44336', 'warning': '#FF9800' };
            const icons = { 'info': '‚ÑπÔ∏è', 'success': '‚úÖ', 'error': '‚ùå', 'warning': '‚ö†Ô∏è' };
            
            const timestamp = new Date().toLocaleTimeString();
            const log = document.createElement('p');
            log.style.margin = '5px 0';
            log.style.padding = '8px';
            log.style.background = '#f8f9fa';
            log.style.borderLeft = `4px solid ${colors[type]}`;
            log.style.borderRadius = '4px';
            log.innerHTML = `<strong>[${timestamp}]</strong> ${icons[type]} ${message}`;
            
            content.appendChild(log);
            content.scrollTop = content.scrollHeight;
        }

        window.addEventListener('load', function() {
            setTimeout(function() {
                logVisual('P√°gina cargada', 'success');
                
                // Verificar ATHM_Checkout
                if (window.ATHM_Checkout) {
                    logVisual('ATHM_Checkout: ‚úì Existe', 'success');
                    logVisual('Token: ' + window.ATHM_Checkout.publicToken.substring(0, 10) + '...', 'info');
                    logVisual('Monto: $' + window.ATHM_Checkout.total, 'info');
                } else {
                    logVisual('ATHM_Checkout: ‚úó NO EXISTE', 'error');
                }
                
                // Verificar bot√≥n
                const container = document.querySelector('#ATHMovil_Checkout_Button_payment');
                const hasButton = container && container.innerHTML.trim().length > 50;
                
                if (hasButton) {
                    logVisual('Bot√≥n: ‚úì GENERADO', 'success');
                } else {
                    logVisual('Bot√≥n: ‚úó NO GENERADO', 'error');
                }
                
                const button = document.querySelector('[id^="buttonATHM"]');
                if (button) {
                    logVisual('Bot√≥n ATH encontrado: ' + button.id, 'success');
                    button.addEventListener('click', function() {
                        logVisual('üñ±Ô∏è CLICK EN BOT√ìN', 'warning');
                    }, true);
                }
                
                // Interceptar XHR - VERSI√ìN MEJORADA
                const originalOpen = XMLHttpRequest.prototype.open;
                const originalSend = XMLHttpRequest.prototype.send;
                
                XMLHttpRequest.prototype.open = function(method, url) {
                    this._method = method;
                    this._url = url;
                    return originalOpen.apply(this, arguments);
                };
                
                XMLHttpRequest.prototype.send = function(body) {
                    const url = this._url || '';
                    
                    // Log de la petici√≥n
                    if (url.includes('athmovil') || url.includes('payment') || url.includes('ecommerce')) {
                        logVisual('üì§ Enviando petici√≥n a ATH...', 'info');
                        logVisual('URL: ' + url.substring(0, 60) + '...', 'info');
                        logVisual('Method: ' + this._method, 'info');
                        
                        // Log del body si existe
                        if (body) {
                            try {
                                const bodyData = JSON.parse(body);
                                logVisual('Token: ' + (bodyData.publicToken || '').substring(0, 10) + '...', 'info');
                                logVisual('Total: 
                
                logVisual('üéØ Sistema iniciado - Haz click en el bot√≥n', 'success');
                
            }, 1500);
        });
        
        console.log('‚úÖ [3/3] Debug inicializado');
    </script>
    
</body>
</html> + bodyData.total, 'info');
                            } catch(e) {}
                        }
                    }
                    
                    // Interceptar respuesta
                    this.addEventListener('load', function() {
                        const responseUrl = this.responseURL || this._url || '';
                        
                        if (responseUrl.includes('athmovil') || responseUrl.includes('payment') || responseUrl.includes('ecommerce')) {
                            logVisual('üì• Respuesta recibida', 'info');
                            logVisual('Status HTTP: ' + this.status, 'info');
                            
                            try {
                                const response = JSON.parse(this.responseText);
                                logVisual('Status: ' + response.status, response.status === 'success' ? 'success' : 'error');
                                
                                if (response.status === 'error') {
                                    logVisual('üö® C√ìDIGO ERROR: ' + response.errorcode, 'error');
                                    logVisual('üìù MENSAJE: ' + response.message, 'error');
                                    
                                    const errors = {
                                        'BTRA_0001': 'Monto muy bajo (m√≠nimo $1.00)',
                                        'BTRA_0003': '‚ö†Ô∏è MISMA TARJETA en cliente y negocio',
                                        'BTRA_0004': 'Monto excede l√≠mites',
                                        'BTRA_0009': '‚ö†Ô∏è NEGOCIO NO ACTIVO',
                                        'BTRA_0010': '‚ö†Ô∏è ESTADO DEL NEGOCIO NO ES ACTIVO',
                                        'BTRA_0038': 'Metadata muy largo (>40 chars)',
                                        'token.invalid': '‚ö†Ô∏è TOKEN INV√ÅLIDO',
                                        'token.expired': '‚ö†Ô∏è TOKEN EXPIRADO'
                                    };
                                    
                                    if (errors[response.errorcode]) {
                                        logVisual('üí° CAUSA: ' + errors[response.errorcode], 'warning');
                                        
                                        // Soluciones espec√≠ficas
                                        if (response.errorcode === 'BTRA_0003') {
                                            logVisual('‚úÖ SOLUCI√ìN: Usa tarjeta DIFERENTE', 'info');
                                        } else if (response.errorcode === 'BTRA_0009' || response.errorcode === 'BTRA_0010') {
                                            logVisual('‚úÖ SOLUCI√ìN: Activa cuenta en ATH Business', 'info');
                                        } else if (response.errorcode === 'token.invalid') {
                                            logVisual('‚úÖ SOLUCI√ìN: Verifica token en app', 'info');
                                        }
                                    } else {
                                        logVisual('Error no documentado: ' + response.errorcode, 'error');
                                    }
                                    
                                    // Mostrar alerta grande
                                    alert('‚ùå ERROR ATH M√ìVIL\n\nC√≥digo: ' + response.errorcode + '\n' + response.message);
                                    
                                } else if (response.status === 'success') {
                                    logVisual('‚úÖ Transacci√≥n creada exitosamente', 'success');
                                    if (response.data && response.data.ecommerceId) {
                                        logVisual('ID: ' + response.data.ecommerceId, 'info');
                                    }
                                }
                            } catch(e) {
                                logVisual('‚ö†Ô∏è Respuesta no es JSON', 'warning');
                                logVisual('Raw: ' + this.responseText.substring(0, 100), 'info');
                            }
                        }
                    });
                    
                    this.addEventListener('error', function() {
                        if ((this._url || '').includes('athmovil') || (this._url || '').includes('payment')) {
                            logVisual('üö® ERROR DE RED', 'error');
                            alert('Error de conexi√≥n con ATH M√≥vil');
                        }
                    });
                    
                    return originalSend.apply(this, arguments);
                };
                
                logVisual('üéØ Sistema iniciado - Haz click en el bot√≥n', 'success');
                
            }, 1500);
        });
        
        console.log('‚úÖ [3/3] Debug inicializado');
    </script>
    
</body>
</html>